<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>REPORT FG | ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à (Realtime Scan)</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{ --bg:#f8fafc; --card:#ffffff; --text:#111827; --muted:#6b7280; --accent:#2563eb; --border:#e5e7eb }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial }

    header{ position:sticky; top:0; z-index:10; background:var(--card); border-bottom:2px solid var(--accent); padding:14px 18px; display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    header h1{ margin:0; font-size:18px }
    .back{ text-decoration:none; color:var(--text); border:1px solid var(--border); border-radius:12px; padding:8px 12px }
    .back:hover{ transform:translateY(-1px); background:#00000008 }
    .hbtn{ appearance:none; border:1px solid var(--accent); color:#fff; background:var(--accent); padding:8px 12px; border-radius:12px; cursor:pointer; margin-left:auto }

    main{ max-width:100%; margin:0; padding:12px }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow:0 10px 40px #00000012 }
    .btn{ appearance:none; border:1px solid var(--border); background:transparent; color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer }
    .btn.danger{ background:#ef4444; color:#fff; border-color:transparent }

    table{ width:100%; border-collapse:separate; border-spacing:0; border-radius:14px; overflow:hidden; border:1px solid var(--border) }
    thead th{ background:#f1f5f9; font-weight:700; font-size:14px; padding:10px; border-bottom:1px solid var(--border); text-align:left }
    tbody td{ padding:10px; border-bottom:1px solid var(--border); font-size:14px }
    tbody tr:last-child td{ border-bottom:none }
    .right{ text-align:right }
    .chip{ display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); border-radius:999px; padding:6px 10px; background:#f8fafc }
    .small{ font-size:12.5px; color:#6b7280 }
    .toast{ position:fixed; left:50%; bottom:24px; transform:translateX(-50%); background:#16a34a; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:0 10px 40px #00000030; opacity:0; pointer-events:none; transition:.35s }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px) }

    /* Modal Scanner */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:50 }
    .modal.show{ display:flex }
    .panel{ width:min(980px,96vw); height:min(720px,88vh); background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 40px 120px rgba(0,0,0,.35); overflow:hidden; display:flex; flex-direction:column }
    .topbar{ display:flex; align-items:center; gap:8px; padding:10px; border-bottom:1px solid var(--border); background:#f8fafc }

    .scanBox{ position:relative; border-radius:12px; overflow:hidden; border:1px dashed var(--border); background:#000; height:min(72vh,520px) }
    #scanVideo{ width:100%; height:100%; object-fit:cover; display:block }
    #scanOverlay{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none }
    .scan-frame{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
    .scan-frame::before{content:"";display:block;width:min(68vmin,420px);height:min(68vmin,420px);border:3px solid var(--accent);border-radius:18px;box-shadow:0 0 0 9999px #00000042, 0 0 30px #22c55e55 inset}

    @media print{ header,.hbtn,.modal{display:none!important} .card{box-shadow:none;border:none} body{background:#fff} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body>
  <header>
    <a class="back" href="index.html">‚Üê ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    <a class="back" href="wipfg.html">‚Üê ‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡πà‡∏≠‡∏¢</a>
    <h1>REPORT FG ‚Äì ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à (Realtime)</h1>
    <button class="hbtn" id="openScan">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡πÅ‡∏Å‡∏ô (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)</button>
  </header>

  <main>
    <section class="card">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ REPORT FG (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</strong>
        <span class="chip" id="chipCount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        <span class="chip" id="chipQty">‡∏£‡∏ß‡∏° Q'TY = 0</span>
        <span class="chip" id="chipBox">BOX ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -</span>
        <span class="chip" id="chipLast">‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -</span>
      </div>

      <div style="overflow:auto; margin-top:10px">
        <table id="tbl">
          <thead>
            <tr>
              <th>#</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>PART NO</th><th>PART NAME</th>
              <th>PO</th><th>LOT</th><th class="right">Q'TY</th><th>BOX</th><th>‡πÑ‡∏•‡∏ô‡πå</th><th>‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn" id="btnExport">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
        <button class="btn" id="btnPrint">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
        <button class="btn danger" id="btnClearAll">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>

      <div class="small">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô <code>localStorage['fg:records']</code>. ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ</div>
    </section>
  </main>

  <!-- Scanner Modal -->
  <div class="modal" id="scanModal" aria-hidden="true">
    <div class="panel">
      <div class="topbar"><strong>‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</strong><button class="btn" id="closeScan">‡∏õ‡∏¥‡∏î</button></div>
      <div class="scanBox">
        <video id="scanVideo" playsinline muted></video>
        <canvas id="scanOverlay"></canvas>
        <div class="scan-frame" aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</div>

<script>
(function(){
  const FKEY='fg:records', SCANKEY='taggen:last_scan';
  const $=id=>document.getElementById(id);
  const btnExport=$('btnExport'), btnPrint=$('btnPrint'), btnClearAll=$('btnClearAll');
  const tbody=$('tbody'), chipCount=$('chipCount'), chipQty=$('chipQty'), chipBox=$('chipBox'), chipLast=$('chipLast');
  const openScan=$('openScan'), scanModal=$('scanModal'), closeScan=$('closeScan');
  const scanVideo=$('scanVideo'), scanOverlay=$('scanOverlay'), sctx=scanOverlay.getContext('2d');
  const toast=$('toast');

  const today=()=>{const d=new Date(),p=n=>String(n).padStart(2,'0');return{d:`${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`,t:`${p(d.getHours())}:${p(d.getMinutes())}`}}
  const showToast=(m='‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß')=>{toast.textContent=m;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1400)}
  function beep(){try{const a=new (window.AudioContext||window.webkitAudioContext)(),o=a.createOscillator(),g=a.createGain();o.type='square';o.frequency.value=880;o.connect(g);g.connect(a.destination);g.gain.value=0.0001;g.gain.exponentialRampToValueAtTime(0.2,a.currentTime+0.01);o.start();setTimeout(()=>{g.gain.exponentialRampToValueAtTime(0.0001,a.currentTime+0.02);o.stop(a.currentTime+0.05)},120)}catch{} if(navigator.vibrate) navigator.vibrate(60)}

  const load=()=>{try{return JSON.parse(localStorage.getItem(FKEY)||'[]')}catch{return []}}
  const save=l=>{try{localStorage.setItem(FKEY,JSON.stringify(l))}catch{}}

  function render(){const list=load();tbody.innerHTML='';let total=0;list.forEach((it,i)=>{total+=Number(it.qty)||0;const tr=document.createElement('tr');tr.innerHTML=`<td>${i+1}</td><td>${it.date||''}</td><td>${it.time||''}</td><td>${it.partNo||''}</td><td>${it.partName||''}</td><td>${it.po||''}</td><td>${it.lot||''}</td><td class='right'>${it.qty||''}</td><td>${it.box||''}</td><td>${it.line||''}</td><td>${it.operator||''}</td><td><button class='btn' data-del='${i}'>‡∏•‡∏ö</button></td>`;tbody.appendChild(tr)});chipCount.textContent=`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${list.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;chipQty.textContent=`‡∏£‡∏ß‡∏° Q'TY = ${total}`;chipBox.textContent=`BOX ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${list.length?(list[list.length-1].box||'-'):'-'}`;}

  function addFromParsed(p){const t=today();const rec={date:t.d,time:t.t,partNo:p.partNo||'',partName:p.partName||'',po:p.po||'',lot:p.lot||'',qty:p.qty||'',box:p.box||'',line:'',operator:'',note:''};const list=load();list.push(rec);save(list);render();chipLast.textContent=`‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${rec.partNo||'-'} (QTY ${rec.qty||'-'})`}

  function exportCSV(){const list=load();if(!list.length){alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');return}const heads=['date','time','partNo','partName','po','lot','qty','box','line','operator','note'];const rows=[heads.join(',')];list.forEach(it=>rows.push(heads.map(k=>`\"${String(it[k]??'').replace(/\"/g,'\"\"')}\"`).join(',')));const csv=rows.join('\\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');const p=n=>String(n).padStart(2,'0');const d=new Date();a.download=`fg_report_${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}.csv`;a.href=URL.createObjectURL(blob);a.click();setTimeout(()=>URL.revokeObjectURL(a.href),1000)}

  render();
  tbody.addEventListener('click',e=>{const b=e.target.closest('button[data-del]');if(!b) return;const i=+b.dataset.del;const list=load();list.splice(i,1);save(list);render()});
  btnExport.onclick=exportCSV; btnPrint.onclick=()=>window.print(); btnClearAll.onclick=()=>{if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){save([]);render()}};

  // --- Scanner ---
  let sStream=null,sDetector=null,sAnim=0,sUsingBD=('BarcodeDetector'in window),sLast=null;
  async function startScanner(){stopScanner();const cons={video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}};sStream=await navigator.mediaDevices.getUserMedia(cons);scanVideo.srcObject=sStream;await scanVideo.play();scanOverlay.width=scanVideo.videoWidth;scanOverlay.height=scanVideo.videoHeight;if(sUsingBD){try{sDetector=new BarcodeDetector({formats:['qr_code']})}catch(e){sUsingBD=false;sDetector=null}}sLoop()}
  function stopScanner(){cancelAnimationFrame(sAnim);if(sStream){sStream.getTracks().forEach(t=>t.stop())}sStream=null;sDetector=null;sctx.clearRect(0,0,scanOverlay.width,scanOverlay.height)}
  function sDraw(pts){if(!pts) return;sctx.clearRect(0,0,scanOverlay.width,scanOverlay.height);sctx.lineWidth=4;sctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent');sctx.beginPath();sctx.moveTo(pts[0].x,pts[0].y);for(let i=1;i<pts.length;i++) sctx.lineTo(pts[i].x,pts[i].y);sctx.closePath();sctx.stroke()}
  function sHandle(text,pts){if(!text||text===sLast) return;sLast=text;sDraw(pts);const p=parsePayload(text);try{localStorage.setItem(SCANKEY,JSON.stringify(p))}catch{};beep();addFromParsed(p);showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥')}
  async function sLoop(){if(!scanVideo||scanVideo.readyState<2){sAnim=requestAnimationFrame(sLoop);return}if(scanOverlay.width!==scanVideo.videoWidth){scanOverlay.width=scanVideo.videoWidth;scanOverlay.height=scanVideo.videoHeight}try{if(sUsingBD&&sDetector){const codes=await sDetector.detect(scanVideo);if(codes?.length){const c=codes[0];const pts=c.cornerPoints?.map(p=>({x:p.x,y:p.y}))||null;sHandle(c.rawValue||'',pts)}else{sctx.clearRect(0,0,scanOverlay.width,scanOverlay.height)}}else if(window.jsQR){const c=document.createElement('canvas');c.width=scanVideo.videoWidth;c.height=scanVideo.videoHeight;const cx=c.getContext('2d');cx.drawImage(scanVideo,0,0,c.width,c.height);const img=cx.getImageData(0,0,c.width,c.height);const code=jsQR(img.data,img.width,img.height,{inversionAttempts:'dontInvert'});if(code){const l=code.location;const pts=l?[{x:l.topLeftCorner.x,y:l.topLeftCorner.y},{x:l.topRightCorner.x,y:l.topRightCorner.y},{x:l.bottomRightCorner.x,y:l.bottomRightCorner.y},{x:l.bottomLeftCorner.x,y:l.bottomLeftCorner.y}]:null;sHandle(code.data,pts)}else{sctx.clearRect(0,0,scanOverlay.width,scanOverlay.height)}}}catch(e){console.error(e)}sAnim=requestAnimationFrame(sLoop)}
  function openScanner(){scanModal.classList.add('show');startScanner().catch(e=>alert('‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\\n'+e))}
  function closeScanner(){stopScanner();scanModal.classList.remove('show')}
  openScan.addEventListener('click',openScanner); closeScan.addEventListener('click',closeScanner);

  // parse helpers
  function normalizeKey(k){return String(k).toLowerCase().replace(/[\\s'\"()_\\-\\.]/g,'').replace(/q'ty|qty|qtty|qyt|quantity/,'qty')}
  function normalizeObject(obj){const out={};for(const [k,v]of Object.entries(obj||{})){const key=normalizeKey(k);const val=String(v??'').trim();if(['partno','pn','pno'].includes(key))out.partNo=val;else if(['partname','name','pname'].includes(key))out.partName=val;else if(['po','pono','purchaseorder'].includes(key))out.po=val;else if(['lot','lotno','lotnumber','batch','batchno'].includes(key))out.lot=val;else if(['qty'].includes(key))out.qty=val;else if(['box','boxno','carton','ctn','cartonno'].includes(key))out.box=val;}return out}
  function parsePayload(text){const res={partNo:'',partName:'',po:'',lot:'',qty:'',box:''};if(!text||!text.trim())return res;let t=text.trim();try{if(t.startsWith('{')){const o=JSON.parse(t);return {...res,...normalizeObject(o)}}}catch{}const pairs=t.split(/[\\n;]+/g).map(s=>s.trim()).filter(Boolean);const acc={};let used=0;for(const line of pairs){const m=line.match(/^\\s*([^:=,]+)\\s*[:=]\\s*(.+)$/);if(m){acc[m[1].trim()]=m[2].trim();used++}}if(used)return{...res,...normalizeObject(acc)};const csv=t.split(/,\\s*/g);if(csv.length>=6){[res.partNo,res.partName,res.po,res.lot,res.qty,res.box]=csv;return res}res.partNo=t;return res}

  // Fallback: postMessage ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
  window.addEventListener('message',ev=>{const d=ev.data;if(!d||d.type!=='qr-decoded'||!d.text)return;const p=parsePayload(d.text);try{localStorage.setItem(SCANKEY,JSON.stringify(p))}catch{};beep();addFromParsed(p);showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥')});
})();
</script>
</body>
</html>
